import os
import streamlit as st
import webbrowser
from bs4 import BeautifulSoup

def get_test_status_from_html(file_path):
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            soup = BeautifulSoup(f, "html.parser")
            rows = soup.find_all("tr")
            statuses = [td.text.strip() for row in rows for td in row.find_all("td")[1:2]]
            if all(status.upper() == "PASS" for status in statuses if status):
                return "PASS"
            else:
                return "FAIL"
    except Exception as e:
        return f"Error"

# Get the latest report folder
results_dir = "results"
all_folders = sorted(
    [os.path.join(results_dir, f) for f in os.listdir(results_dir) if os.path.isdir(os.path.join(results_dir, f))],
    key=os.path.getmtime,
    reverse=True
)

if all_folders:
    latest_folder = all_folders[0]
    report_files = [f for f in os.listdir(latest_folder) if f.endswith(".html")]

    st.header("Test Execution Summary")

    for report in report_files:
        full_path = os.path.join(latest_folder, report)
        test_case_name = report.replace(".html", "")
        status = get_test_status_from_html(full_path)
        status_color = "green" if status == "PASS" else "red"

        cols = st.columns([4, 1, 2])
        cols[0].markdown(f"**{test_case_name}**")
        cols[1].markdown(f"<span style='color:{status_color}'>{status}</span>", unsafe_allow_html=True)
        if cols[2].button(f"Open Report: {test_case_name}"):
            webbrowser.open_new_tab("file://" + os.path.abspath(full_path))
else:
    st.warning("No reports found.")


import re
# Assuming `report` is the filename like 'Test_Report_Verify GPS Member Actionable Alert for Commercial_223452.html'
test_case_name = re.sub(r'^Test_Report_(.*)_\d{6,}\.html$', r'\1', report)
